import { Express } from "express";
import { Server } from "http";
import { eq, ilike, sql } from "drizzle-orm";
import { db } from "./database.js";
import * as schema from "../shared/schema.js";

import {
  insertLoaiHopDongSchema,
  insertCanBoSchema,
  insertNhaCungCapSchema,
  insertChuDauTuSchema,
  insertHopDongSchema,
  insertLoaiNganSachSchema,
  insertLoaiTienSchema,
  insertThanhToanSchema,
  insertTrangBiSchema,
  insertBuocThucHienSchema,
  insertFileHopDongSchema,
  insertHopDongTienDoSchema,
  insertDiaDiemThongQuanSchema,
  insertTiepNhanSchema,
  insertCapTienSchema,
  updateCapTienSchema,
} from "../shared/schema.js";
import multer from "multer";
import path from "path";
const upload = multer({
  storage: multer.memoryStorage(), // L∆∞u file trong RAM (c√≥ th·ªÉ ƒë·ªïi th√†nh diskStorage)
  limits: {
    fileSize: 1000 * 1024 * 1024, // 10MB
  },
});
export async function registerRoutes(app: Express): Promise<void> {
  // System overview route
  app.get("/api/system/overview", async (req, res) => {
    try {
      const contracts = await db.select().from(schema.hopDong);
      const payments = await db.select().from(schema.thanhToan);
      const equipment = await db.select().from(schema.trangBi);
      const documents = await db.select().from(schema.fileHopDong);
      const progressSteps = await db.select().from(schema.buocThucHien);
      const loaiTienList = await db.select().from(schema.loaiTien);
      const totalValueByCurrency = loaiTienList.map((currency) => {
        const relatedContracts = contracts.filter(
          (c) => c.loaiTienId === currency.id
        );
        const total = relatedContracts.reduce(
          (sum, c) => sum + (c.giaTriHopDong || 0),
          0
        );
        return {
          currency: currency.ten,
          totalValue: total,
        };
      });
      const totalUyThacByCurrency = loaiTienList.map((currency) => {
        const relatedContracts = contracts.filter(
          (c) => c.loaiTienId === currency.id
        );
        const total = relatedContracts.reduce((sum, c) => {
          const phiUyThac = parseFloat(c.phiUyThac?.toString() || "0");
          const tyGia = parseFloat(c.tyGia?.toString() || "1"); // default 1 n·∫øu kh√¥ng c√≥ t·ª∑ gi√°
          return sum + phiUyThac * tyGia;
        }, 0);
        return {
          currency: currency.ten,
          totalValue: total,
        };
      });
      const stats = {
        totalContracts: contracts.length,
        activeContracts: contracts.filter((c) => c.trangThaiHopDongId === 1)
          .length,
        completedContracts: contracts.filter((c) => c.trangThaiHopDongId === 2)
          .length,
        pausedContracts: contracts.filter((c) => c.trangThaiHopDongId === 3)
          .length,
        totalValue: contracts.reduce(
          (sum, c) => sum + (c.giaTriHopDong || 0),
          0
        ),
        totalUyThacByCurrency,
        totalValueByCurrency, // üëâ th√™m v√†o ƒë√¢y
        totalPayments: payments.length,
        pendingPayments: payments.filter((p) => p.daThanhToan === false).length,
        completedPayments: payments.filter((p) => p.daThanhToan === true)
          .length,
        totalEquipment: equipment.length,
        totalDocuments: documents.length,
        totalProgressSteps: progressSteps.length,
        inProgressSteps: progressSteps.filter(
          (p) => p.trangThai === "ƒêang th·ª±c hi·ªán"
        ).length,
        completedSteps: progressSteps.filter(
          (p) => p.trangThai === "Ho√†n th√†nh"
        ).length,
        pendingSteps: progressSteps.filter(
          (p) => p.trangThai === "Ch∆∞a b·∫Øt ƒë·∫ßu"
        ).length,
      };

      res.json(stats);
    } catch (error) {
      console.error("Error fetching system overview:", error);
      res.status(500).json({ error: "L·ªói server" });
    }
  });

  // Download project route
  app.get("/api/download/project", (req, res) => {
    const filePath =
      "/home/runner/workspace/vietnamese-contract-management-fixed.tar.gz";
    res.download(
      filePath,
      "vietnamese-contract-management-fixed.tar.gz",
      (err) => {
        if (err) {
          console.error("Download error:", err);
          res.status(500).json({ error: "Kh√¥ng th·ªÉ t·∫£i file" });
        }
      }
    );
  });

  // Dashboard charts route
  app.get("/api/dashboard/charts", async (req, res) => {
    try {
      const contractTypes = await db.select().from(schema.loaiHopDong);
      const contracts = await db.select().from(schema.hopDong);

      const contractTypeData = contractTypes.map((type) => ({
        name: type.ten,
        value: contracts.filter((c) => c.loaiHopDongId === type.id).length,
      }));

      const payments = await db.select().from(schema.thanhToan);
      const paymentStatusData = [
        {
          name: "ƒê√£ thanh to√°n",
          value: payments.filter((p) => p.daThanhToan === true).length,
        },
        {
          name: "Ch∆∞a thanh to√°n",
          value:
            payments.filter((p) => p.daThanhToan === false).length ||
            payments.length,
        },
      ];

      const progressSteps = await db.select().from(schema.buocThucHien);
      const progressStatusData = [
        {
          name: "Ho√†n th√†nh",
          value: progressSteps.filter((p) => p.trangThai === "Ho√†n th√†nh")
            .length,
        },
        {
          name: "ƒêang th·ª±c hi·ªán",
          value: progressSteps.filter((p) => p.trangThai === "ƒêang th·ª±c hi·ªán")
            .length,
        },
        {
          name: "Ch∆∞a b·∫Øt ƒë·∫ßu",
          value: progressSteps.filter((p) => p.trangThai === "Ch∆∞a b·∫Øt ƒë·∫ßu")
            .length,
        },
      ];

      // Supplier statistics by country
      const suppliers = await db.select().from(schema.nhaCungCap);

      const supplierCountryMap = new Map<string, number>();

      for (const supplier of suppliers) {
        const code = supplier.maQuocGia;
        if (!code) continue; // B·ªè qua n·∫øu thi·∫øu m√£ qu·ªëc gia

        supplierCountryMap.set(code, (supplierCountryMap.get(code) ?? 0) + 1);
      }

      const supplierCountryData = Array.from(supplierCountryMap.entries())
        .map(([name, value]) => ({ name: name, value }))
        .filter((item) => item.value > 0);

      // World map data for countries with suppliers and contracts
      const supplierMap = new Map<
        string,
        { count: number; suppliers: typeof suppliers }
      >();
      for (const supplier of suppliers) {
        if (!supplier.maQuocGia) continue;

        if (!supplierMap.has(supplier.maQuocGia)) {
          supplierMap.set(supplier.diaChi, {
            count: 0,
            suppliers: [],
          });
        }

        const group = supplierMap.get(supplier.diaChi)!;
        group.suppliers.push(supplier);
        group.count++;
      }

      const worldMapData = [];

      for (const [
        countryCode,

        { suppliers: countrySuppliers },
      ] of supplierMap.entries()) {
        // ƒê·∫øm h·ª£p ƒë·ªìng li√™n quan
        const contractCount = contracts.filter((contract) =>
          countrySuppliers.some(
            (supplier) => supplier.id === contract.nhaCungCapId
          )
        ).length;

        if (contractCount > 0) {
          // L·∫•y t·ªça ƒë·ªô trung b√¨nh t·ª´ c√°c supplier trong qu·ªëc gia ƒë√≥

          worldMapData.push({
            country: countryCode, // v·∫´n d√πng m√£ qu·ªëc gia l√†m t√™n
            count: contractCount,
            suppliers: countrySuppliers.length,
          });
        }
      }

      res.json({
        contractTypes: contractTypeData,
        paymentStatus: paymentStatusData,
        progressStatus: progressStatusData,
        supplierCountries: supplierCountryData,
        worldMap: worldMapData,
        monthlyTrend: [],
      });
    } catch (error) {
      console.error("Error fetching dashboard charts:", error);
      res.status(500).json({ error: "L·ªói server" });
    }
  });

  // Lo·∫°i h·ª£p ƒë·ªìng routes
  app.get("/api/loai-hop-dong", async (req, res) => {
    try {
      const items = await db.select().from(schema.loaiHopDong);
      res.json(items);
    } catch (error) {
      console.error("Error fetching loai hop dong:", error);
      res.status(500).json({ error: "L·ªói server" });
    }
  });

  app.post("/api/loai-hop-dong", async (req, res) => {
    try {
      const validatedData = insertLoaiHopDongSchema.parse(req.body);
      const items = await db
        .insert(schema.loaiHopDong)
        .values(validatedData)
        .returning();
      res.status(201).json(items[0]);
    } catch (error) {
      console.error("Error creating loai hop dong:", error);
      res.status(500).json({ error: "L·ªói khi t·∫°o lo·∫°i h·ª£p ƒë·ªìng" });
    }
  });

  // C√°n b·ªô routes
  app.get("/api/can-bo", async (req, res) => {
    try {
      const items = await db.select().from(schema.canBo);
      res.json(items);
    } catch (error) {
      console.error("Error fetching can bo:", error);
      res.status(500).json({ error: "L·ªói khi l·∫•y danh s√°ch c√°n b·ªô" });
    }
  });

  app.post("/api/can-bo", async (req, res) => {
    try {
      const validatedData = insertCanBoSchema.parse(req.body);
      const items = await db
        .insert(schema.canBo)
        .values(validatedData)
        .returning();
      res.status(201).json(items[0]);
    } catch (error) {
      console.error("Error creating can bo:", error);
      res.status(500).json({ error: "L·ªói khi t·∫°o c√°n b·ªô" });
    }
  });
  app.put("/api/can-bo/:id", async (req, res) => {
    try {
      const id = parseInt(req.params.id);
      const validatedData = insertCanBoSchema.parse(req.body);

      const updated = await db
        .update(schema.canBo)
        .set(validatedData)
        .where(eq(schema.canBo.id, id))
        .returning();

      if (updated.length === 0) {
        return res.status(404).json({ error: "Kh√¥ng t√¨m th·∫•y c√°n b·ªô" });
      }

      res.json(updated[0]);
    } catch (error) {
      console.error("Error updating can bo:", error);
      res.status(500).json({ error: "L·ªói khi c·∫≠p nh·∫≠t c√°n b·ªô" });
    }
  });
  app.delete("/api/can-bo/:id", async (req, res) => {
    try {
      const id = parseInt(req.params.id);
      console.log(id);
      const deleted = await db
        .delete(schema.canBo)
        .where(eq(schema.canBo.id, id))
        .returning();

      if (deleted.length === 0) {
        return res.status(404).json({ error: "Kh√¥ng t√¨m th·∫•y c√°n b·ªô ƒë·ªÉ x√≥a" });
      }

      res.json({ message: "ƒê√£ x√≥a c√°n b·ªô th√†nh c√¥ng", item: deleted[0] });
    } catch (error) {
      console.error("Error deleting can bo:", error);
      res.status(500).json({ error: "L·ªói khi x√≥a c√°n b·ªô" });
    }
  });

  // Nh√† cung c·∫•p routes
  app.get("/api/nha-cung-cap", async (req, res) => {
    try {
      const items = await db.select().from(schema.nhaCungCap);
      res.json(items);
    } catch (error) {
      console.error("Error fetching nha cung cap:", error);
      res.status(500).json({ error: "L·ªói khi l·∫•y danh s√°ch nh√† cung c·∫•p" });
    }
  });

  app.post("/api/nha-cung-cap", async (req, res) => {
    try {
      const validatedData = insertNhaCungCapSchema.parse(req.body);
      const items = await db
        .insert(schema.nhaCungCap)
        .values(validatedData)
        .returning();
      res.status(201).json(items[0]);
    } catch (error) {
      console.error("Error creating nha cung cap:", error);
      res.status(500).json({ error: "L·ªói khi t·∫°o nh√† cung c·∫•p" });
    }
  });
  app.put("/api/nha-cung-cap/:id", async (req, res) => {
    try {
      const id = parseInt(req.params.id);
      const validatedData = insertNhaCungCapSchema.parse(req.body);

      const updated = await db
        .update(schema.nhaCungCap)
        .set(validatedData)
        .where(eq(schema.nhaCungCap.id, id))
        .returning();

      if (updated.length === 0) {
        return res.status(404).json({ error: "Kh√¥ng t√¨m th·∫•y nh√† cung c·∫•p" });
      }

      res.json(updated[0]);
    } catch (error) {
      console.error("Error updating nha cung cap:", error);
      res.status(500).json({ error: "L·ªói khi c·∫≠p nh·∫≠t nh√† cung c·∫•p" });
    }
  });
  app.delete("/api/nha-cung-cap/:id", async (req, res) => {
    try {
      const id = parseInt(req.params.id);

      const deleted = await db
        .delete(schema.nhaCungCap)
        .where(eq(schema.nhaCungCap.id, id))
        .returning();

      if (deleted.length === 0) {
        return res.status(404).json({ error: "Kh√¥ng t√¨m th·∫•y nh√† cung c·∫•p" });
      }

      res.json({ message: "ƒê√£ xo√° nh√† cung c·∫•p th√†nh c√¥ng" });
    } catch (error) {
      console.error("Error deleting nha cung cap:", error);
      res.status(500).json({ error: "L·ªói khi xo√° nh√† cung c·∫•p" });
    }
  });

  // Ch·ªß ƒë·∫ßu t∆∞ routes
  app.get("/api/chu-dau-tu", async (req, res) => {
    try {
      const items = await db.select().from(schema.chuDauTu);
      res.json(items);
    } catch (error) {
      console.error("Error fetching chu dau tu:", error);
      res.status(500).json({ error: "L·ªói server" });
    }
  });

  app.post("/api/chu-dau-tu", async (req, res) => {
    try {
      const validatedData = insertChuDauTuSchema.parse(req.body);
      const items = await db
        .insert(schema.chuDauTu)
        .values(validatedData)
        .returning();
      res.status(201).json(items[0]);
    } catch (error) {
      console.error("Error creating chu dau tu:", error);
      res.status(500).json({ error: "L·ªói khi t·∫°o ch·ªß ƒë·∫ßu t∆∞" });
    }
  });
  // C·∫≠p nh·∫≠t ch·ªß ƒë·∫ßu t∆∞
  app.put("/api/chu-dau-tu/:id", async (req, res) => {
    try {
      const { id } = req.params;
      const validatedData = insertChuDauTuSchema.parse(req.body); // S·ª≠ d·ª•ng schema gi·ªëng POST
      const updated = await db
        .update(schema.chuDauTu)
        .set(validatedData)
        .where(eq(schema.chuDauTu.id, Number(id)))
        .returning();
      if (updated.length === 0) {
        return res.status(404).json({ error: "Kh√¥ng t√¨m th·∫•y ch·ªß ƒë·∫ßu t∆∞" });
      }
      res.json(updated[0]);
    } catch (error) {
      console.error("Error updating chu dau tu:", error);
      res.status(500).json({ error: "L·ªói khi c·∫≠p nh·∫≠t ch·ªß ƒë·∫ßu t∆∞" });
    }
  });

  // X√≥a ch·ªß ƒë·∫ßu t∆∞
  app.delete("/api/chu-dau-tu/:id", async (req, res) => {
    try {
      const { id } = req.params;
      const deleted = await db
        .delete(schema.chuDauTu)
        .where(eq(schema.chuDauTu.id, Number(id)))
        .returning();
      if (deleted.length === 0) {
        return res.status(404).json({ error: "Kh√¥ng t√¨m th·∫•y ch·ªß ƒë·∫ßu t∆∞" });
      }
      res.json({ message: "ƒê√£ x√≥a th√†nh c√¥ng", data: deleted[0] });
    } catch (error) {
      console.error("Error deleting chu dau tu:", error);
      res.status(500).json({ error: "L·ªói khi x√≥a ch·ªß ƒë·∫ßu t∆∞" });
    }
  });

  // Lo·∫°i ng√¢n s√°ch routes
  app.get("/api/loai-ngan-sach", async (req, res) => {
    try {
      const items = await db.select().from(schema.loaiNganSach);
      res.json(items);
    } catch (error) {
      console.error("Error fetching loai ngan sach:", error);
      res.status(500).json({ error: "L·ªói server" });
    }
  });

  // T·∫°o lo·∫°i ng√¢n s√°ch m·ªõi
  app.post("/api/loai-ngan-sach", async (req, res) => {
    try {
      const { ten } = req.body;
      if (!ten) {
        return res
          .status(400)
          .json({ error: "T√™n lo·∫°i ng√¢n s√°ch l√† b·∫Øt bu·ªôc" });
      }

      const [newItem] = await db
        .insert(schema.loaiNganSach)
        .values({ ten })
        .returning();

      res.status(201).json(newItem);
    } catch (error) {
      console.error("Error creating loai ngan sach:", error);
      res.status(500).json({ error: "L·ªói server" });
    }
  });

  // C·∫≠p nh·∫≠t lo·∫°i ng√¢n s√°ch
  app.put("/api/loai-ngan-sach/:id", async (req, res) => {
    try {
      const id = Number(req.params.id);
      const { ten } = req.body;

      const [updated] = await db
        .update(schema.loaiNganSach)
        .set({ ten })
        .where(eq(schema.loaiNganSach.id, id))
        .returning();

      if (!updated) {
        return res.status(404).json({ error: "Kh√¥ng t√¨m th·∫•y lo·∫°i ng√¢n s√°ch" });
      }

      res.json(updated);
    } catch (error) {
      console.error("Error updating loai ngan sach:", error);
      res.status(500).json({ error: "L·ªói server" });
    }
  });

  // X√≥a lo·∫°i ng√¢n s√°ch
  app.delete("/api/loai-ngan-sach/:id", async (req, res) => {
    try {
      const id = Number(req.params.id);

      const [deleted] = await db
        .delete(schema.loaiNganSach)
        .where(eq(schema.loaiNganSach.id, id))
        .returning();

      if (!deleted) {
        return res.status(404).json({ error: "Kh√¥ng t√¨m th·∫•y lo·∫°i ng√¢n s√°ch" });
      }

      res.json({ message: "ƒê√£ x√≥a th√†nh c√¥ng", deleted });
    } catch (error) {
      console.error("Error deleting loai ngan sach:", error);
      res.status(500).json({ error: "L·ªói server" });
    }
  });
  // Lo·∫°i ti·ªÅn routes
  app.get("/api/loai-tien", async (req, res) => {
    try {
      const items = await db.select().from(schema.loaiTien);
      res.json(items);
    } catch (error) {
      console.error("Error fetching loai tien:", error);
      res.status(500).json({ error: "L·ªói server" });
    }
  });

  // Tr·∫°ng th√°i h·ª£p ƒë·ªìng routes
  app.get("/api/trang-thai-hop-dong", async (req, res) => {
    try {
      const items = await db.select().from(schema.trangThaiHopDong);
      res.json(items);
    } catch (error) {
      console.error("Error fetching trang thai hop dong:", error);
      res.status(500).json({ error: "L·ªói server" });
    }
  });

  // H·ª£p ƒë·ªìng routes
  app.get("/api/hop-dong", async (req, res) => {
    console.log("üîç API /api/hop-dong ƒë∆∞·ª£c g·ªçi");
    const search = req.query.search;
    console.log("Search:", search);
    try {
      let items;

      if (search) {
        const keyword = `%${search}%`;
        items = await db
          .select()
          .from(schema.hopDong)
          .where(
            sql`LOWER(${schema.hopDong.ten}) LIKE LOWER(${keyword}) OR LOWER(${schema.hopDong.soHdNgoai}) LIKE LOWER(${keyword})`
          );
      } else {
        items = await db.select().from(schema.hopDong);
      }

      res.json(items);
    } catch (error) {
      console.error("Error fetching hop dong:", error);
      res.status(500).json({ error: "L·ªói khi l·∫•y danh s√°ch h·ª£p ƒë·ªìng" });
    }
  });

  app.post("/api/hop-dong", async (req, res) => {
    try {
      const validatedData = insertHopDongSchema.parse(req.body);
      const items = await db
        .insert(schema.hopDong)
        .values(validatedData)
        .returning();
      res.status(201).json(items[0]);
    } catch (error) {
      console.error("Error creating hop dong:", error);
      res.status(500).json({ error: "L·ªói khi t·∫°o h·ª£p ƒë·ªìng" });
    }
  });

  app.put("/api/hop-dong/:id", async (req, res) => {
    const id = req.params.id;
    try {
      // Validate d·ªØ li·ªáu ƒë·∫ßu v√†o (n·∫øu c·∫ßn ch·ªânh s·ª≠a th√¨ d√πng schema ri√™ng)
      const validatedData = insertHopDongSchema.parse(req.body);
      console.log("Validated Data:", validatedData);
      const updated = await db
        .update(schema.hopDong)
        .set(validatedData)
        .where(eq(schema.hopDong.id, Number(id))) // Convert string id to number
        .returning();
      if (updated.length === 0) {
        return res
          .status(404)
          .json({ error: "Kh√¥ng t√¨m th·∫•y h·ª£p ƒë·ªìng ƒë·ªÉ c·∫≠p nh·∫≠t" });
      }
      res.json(updated[0]);
    } catch (error) {
      console.error("Error updating hop dong:", error);
      res.status(500).json({ error: "L·ªói khi c·∫≠p nh·∫≠t h·ª£p ƒë·ªìng" });
    }
  });

  app.delete("/api/hop-dong/:id", async (req, res) => {
    const id = req.params.id;
    try {
      const deleted = await db
        .delete(schema.hopDong)
        .where(eq(schema.hopDong.id, Number(id))) // ho·∫∑c Number(id) n·∫øu id l√† s·ªë
        .returning();

      if (deleted.length === 0) {
        return res
          .status(404)
          .json({ error: "Kh√¥ng t√¨m th·∫•y h·ª£p ƒë·ªìng ƒë·ªÉ x√≥a" });
      }

      res.json({ message: "ƒê√£ x√≥a h·ª£p ƒë·ªìng th√†nh c√¥ng", item: deleted[0] });
    } catch (error) {
      console.error("Error deleting hop dong:", error);
      res.status(500).json({ error: "L·ªói khi x√≥a h·ª£p ƒë·ªìng" });
    }
  });

  // Thanh to√°n routes
  app.get("/api/thanh-toan", async (req, res) => {
    try {
      const items = await db.select().from(schema.thanhToan);
      res.json(items);
    } catch (error) {
      console.error("Error fetching thanh toan:", error);
      res.status(500).json({ error: "L·ªói server" });
    }
  });

  app.post("/api/thanh-toan", async (req, res) => {
    try {
      const validatedData = insertThanhToanSchema.parse(req.body);
      const items = await db
        .insert(schema.thanhToan)
        .values(validatedData)
        .returning();
      res.status(201).json(items[0]);
    } catch (error) {
      console.error("Error creating thanh toan:", error);
      res.status(500).json({ error: "L·ªói khi t·∫°o thanh to√°n" });
    }
  });
  // PUT: C·∫≠p nh·∫≠t thanh to√°n
  app.put("/api/thanh-toan/:id", async (req, res) => {
    try {
      const { id } = req.params;
      const validatedData = insertThanhToanSchema.parse(req.body);

      const updated = await db
        .update(schema.thanhToan)
        .set(validatedData)
        .where(eq(schema.thanhToan.id, Number(id)))
        .returning();

      if (updated.length === 0) {
        return res.status(404).json({ error: "Kh√¥ng t√¨m th·∫•y thanh to√°n" });
      }

      res.json(updated[0]);
    } catch (error) {
      console.error("Error updating thanh toan:", error);
      res.status(500).json({ error: "L·ªói khi c·∫≠p nh·∫≠t thanh to√°n" });
    }
  });

  // DELETE: X√≥a thanh to√°n
  app.delete("/api/thanh-toan/:id", async (req, res) => {
    try {
      const { id } = req.params;

      const deleted = await db
        .delete(schema.thanhToan)
        .where(eq(schema.thanhToan.id, Number(id)))
        .returning();

      if (deleted.length === 0) {
        return res.status(404).json({ error: "Kh√¥ng t√¨m th·∫•y thanh to√°n" });
      }

      res.json({ message: "ƒê√£ x√≥a th√†nh c√¥ng", data: deleted[0] });
    } catch (error) {
      console.error("Error deleting thanh toan:", error);
      res.status(500).json({ error: "L·ªói khi x√≥a thanh to√°n" });
    }
  });

  // B∆∞·ªõc th·ª±c hi·ªán routes
  app.get("/api/buoc-thuc-hien", async (req, res) => {
    try {
      const items = await db.select().from(schema.buocThucHien);
      res.json(items);
    } catch (error) {
      console.error("Error fetching buoc thuc hien:", error);
      res.status(500).json({ error: "L·ªói server" });
    }
  });

  app.post("/api/buoc-thuc-hien", async (req, res) => {
    try {
      const validatedData = insertBuocThucHienSchema.parse(req.body);
      const items = await db
        .insert(schema.buocThucHien)
        .values(validatedData)
        .returning();
      res.status(201).json(items[0]);
    } catch (error) {
      console.error("Error creating buoc thuc hien:", error);
      res.status(500).json({ error: "L·ªói khi t·∫°o b∆∞·ªõc th·ª±c hi·ªán" });
    }
  });
  // C·∫≠p nh·∫≠t b∆∞·ªõc th·ª±c hi·ªán theo id
  app.put("/api/buoc-thuc-hien/:id", async (req, res) => {
    try {
      const id = parseInt(req.params.id);
      const validatedData = schema.updateBuocThucHienSchema.parse(req.body); // c·∫ßn c√≥ schema cho update
      const updated = await db
        .update(schema.buocThucHien)
        .set(validatedData)
        .where(eq(schema.buocThucHien.id, id))
        .returning();
      if (updated.length === 0) {
        return res.status(404).json({ error: "Kh√¥ng t√¨m th·∫•y b∆∞·ªõc th·ª±c hi·ªán" });
      }
      res.json(updated[0]);
    } catch (error) {
      console.error("Error updating buoc thuc hien:", error);
      res.status(500).json({ error: "L·ªói khi c·∫≠p nh·∫≠t b∆∞·ªõc th·ª±c hi·ªán" });
    }
  });

  // X√≥a b∆∞·ªõc th·ª±c hi·ªán theo id
  app.delete("/api/buoc-thuc-hien/:id", async (req, res) => {
    try {
      const id = parseInt(req.params.id);
      const deleted = await db
        .delete(schema.buocThucHien)
        .where(eq(schema.buocThucHien.id, id))
        .returning();
      if (deleted.length === 0) {
        return res.status(404).json({ error: "Kh√¥ng t√¨m th·∫•y b∆∞·ªõc th·ª±c hi·ªán" });
      }
      res.json({ message: "X√≥a th√†nh c√¥ng", item: deleted[0] });
    } catch (error) {
      console.error("Error deleting buoc thuc hien:", error);
      res.status(500).json({ error: "L·ªói khi x√≥a b∆∞·ªõc th·ª±c hi·ªán" });
    }
  });

  // L·∫•y t·∫•t c·∫£ b·∫£n ghi c·∫•p ti·ªÅn
  app.get("/api/cap-tien", async (req, res) => {
    try {
      const items = await db.select().from(schema.capTien);
      res.json(items);
    } catch (error) {
      console.error("Error fetching cap tien:", error);
      res.status(500).json({ error: "L·ªói server" });
    }
  });

  // Th√™m m·ªõi b·∫£n ghi c·∫•p ti·ªÅn
  app.post("/api/cap-tien", async (req, res) => {
    try {
      const validatedData = insertCapTienSchema.parse(req.body);
      const items = await db
        .insert(schema.capTien)
        .values(validatedData)
        .returning();
      res.status(201).json(items[0]);
    } catch (error) {
      console.error("Error creating cap tien:", error);
      res.status(500).json({ error: "L·ªói khi t·∫°o c·∫•p ti·ªÅn" });
    }
  });

  // C·∫≠p nh·∫≠t b·∫£n ghi c·∫•p ti·ªÅn theo id
  app.put("/api/cap-tien/:id", async (req, res) => {
    try {
      const id = parseInt(req.params.id);
      const validatedData = updateCapTienSchema.parse(req.body);
      const updated = await db
        .update(schema.capTien)
        .set(validatedData)
        .where(eq(schema.capTien.id, id))
        .returning();
      if (updated.length === 0) {
        return res.status(404).json({ error: "Kh√¥ng t√¨m th·∫•y c·∫•p ti·ªÅn" });
      }
      res.json(updated[0]);
    } catch (error) {
      console.error("Error updating cap tien:", error);
      res.status(500).json({ error: "L·ªói khi c·∫≠p nh·∫≠t c·∫•p ti·ªÅn" });
    }
  });

  // X√≥a b·∫£n ghi c·∫•p ti·ªÅn theo id
  app.delete("/api/cap-tien/:id", async (req, res) => {
    try {
      const id = parseInt(req.params.id);
      const deleted = await db
        .delete(schema.capTien)
        .where(eq(schema.capTien.id, id))
        .returning();
      if (deleted.length === 0) {
        return res.status(404).json({ error: "Kh√¥ng t√¨m th·∫•y c·∫•p ti·ªÅn" });
      }
      res.json({ message: "X√≥a th√†nh c√¥ng", item: deleted[0] });
    } catch (error) {
      console.error("Error deleting cap tien:", error);
      res.status(500).json({ error: "L·ªói khi x√≥a c·∫•p ti·ªÅn" });
    }
  });

  // Trang b·ªã routes
  app.get("/api/trang-bi", async (req, res) => {
    try {
      const items = await db.select().from(schema.trangBi);
      res.json(items);
    } catch (error) {
      console.error("Error fetching trang bi:", error);
      res.status(500).json({ error: "L·ªói server" });
    }
  });

  app.post("/api/trang-bi", async (req, res) => {
    try {
      const validatedData = insertTrangBiSchema.parse(req.body);
      const items = await db
        .insert(schema.trangBi)
        .values(validatedData)
        .returning();
      res.status(201).json(items[0]);
    } catch (error) {
      console.error("Error creating trang bi:", error);
      res.status(500).json({ error: "L·ªói khi t·∫°o trang b·ªã" });
    }
  });
  // C·∫≠p nh·∫≠t trang b·ªã
  app.put("/api/trang-bi/:id", async (req, res) => {
    try {
      const { id } = req.params;
      const validatedData = insertTrangBiSchema.parse(req.body); // c√≥ th·ªÉ d√πng updateSchema n·∫øu c√≥
      const updated = await db
        .update(schema.trangBi)
        .set(validatedData)
        .where(eq(schema.trangBi.id, Number(id)))
        .returning();

      if (updated.length === 0) {
        return res.status(404).json({ error: "Kh√¥ng t√¨m th·∫•y trang b·ªã" });
      }

      res.json(updated[0]);
    } catch (error) {
      console.error("Error updating trang bi:", error);
      res.status(500).json({ error: "L·ªói khi c·∫≠p nh·∫≠t trang b·ªã" });
    }
  });

  // X√≥a trang b·ªã
  app.delete("/api/trang-bi/:id", async (req, res) => {
    try {
      const { id } = req.params;
      const deleted = await db
        .delete(schema.trangBi)
        .where(eq(schema.trangBi.id, Number(id)))
        .returning();

      if (deleted.length === 0) {
        return res.status(404).json({ error: "Kh√¥ng t√¨m th·∫•y trang b·ªã" });
      }

      res.json({ message: "ƒê√£ x√≥a th√†nh c√¥ng", data: deleted[0] });
    } catch (error) {
      console.error("Error deleting trang bi:", error);
      res.status(500).json({ error: "L·ªói khi x√≥a trang b·ªã" });
    }
  });
  // File h·ª£p ƒë·ªìng routes
  app.get("/api/file-hop-dong", async (req, res) => {
    try {
      const items = await db.select().from(schema.fileHopDong);
      res.json(items);
    } catch (error) {
      console.error("Error fetching file hop dong:", error);
      res.status(500).json({ error: "L·ªói server" });
    }
  });

  app.get("/api/file-hop-dong/:id", async (req, res) => {
    try {
      const id = parseInt(req.params.id);
      const items = await db
        .select()
        .from(schema.fileHopDong)
        .where(eq(schema.fileHopDong.id, id));
      if (items.length === 0) {
        return res.status(404).json({ error: "Kh√¥ng t√¨m th·∫•y t√†i li·ªáu" });
      }
      res.json(items[0]);
    } catch (error) {
      console.error("Error fetching file hop dong by id:", error);
      res.status(500).json({ error: "L·ªói server" });
    }
  });
  const toInt = (val: any, fallback = 0) =>
    isNaN(parseInt(val)) ? fallback : parseInt(val);
  app.post("/api/file-hop-dong", upload.single("file"), async (req, res) => {
    try {
      const file = req.file;

      if (!file) {
        return res.status(400).json({ error: "Kh√¥ng c√≥ file ƒë∆∞·ª£c g·ª≠i l√™n" });
      }

      // L·∫•y d·ªØ li·ªáu t·ª´ body
      const { tenFile, loaiFile, hopDongId, nguoiTaiLen, ghiChu } = req.body;

      // Parse & validate b·∫±ng Zod
      const parsedData = insertFileHopDongSchema.parse({
        tenFile,
        loaiFile,
        kichThuoc: file.size, // ‚úÖ l·∫•y t·ª´ file
        hopDongId: toInt(hopDongId),
        nguoiTaiLen: toInt(nguoiTaiLen),
        ghiChu,
      });

      // Convert file.buffer th√†nh base64
      const base64FileContent = file.buffer.toString("base64");

      // L∆∞u v√†o DB
      const items = await db
        .insert(schema.fileHopDong)
        .values({
          ...parsedData,
          noiDungFile: `data:${file.mimetype};base64,${base64FileContent}`,
          ngayTaiLen: new Date().toISOString(),
        })
        .returning();

      res.status(201).json(items[0]);
    } catch (error) {
      console.error("Error:", error);
      if (error instanceof z.ZodError) {
        return res.status(400).json({ error: error.issues });
      }
      res.status(500).json({ error: "L·ªói khi t·∫°o t√†i li·ªáu" });
    }
  });

  app.put("/api/file-hop-dong/:id", async (req, res) => {
    try {
      const id = parseInt(req.params.id);
      const validatedData = insertFileHopDongSchema.partial().parse(req.body);
      const items = await db
        .update(schema.fileHopDong)
        .set(validatedData)
        .where(eq(schema.fileHopDong.id, id))
        .returning();

      if (items.length === 0) {
        return res.status(404).json({ error: "Kh√¥ng t√¨m th·∫•y t√†i li·ªáu" });
      }

      res.json(items[0]);
    } catch (error) {
      console.error("Error updating file hop dong:", error);
      res.status(500).json({ error: "L·ªói khi c·∫≠p nh·∫≠t t√†i li·ªáu" });
    }
  });

  app.delete("/api/file-hop-dong/:id", async (req, res) => {
    try {
      const id = parseInt(req.params.id);
      const items = await db
        .delete(schema.fileHopDong)
        .where(eq(schema.fileHopDong.id, id))
        .returning();

      if (items.length === 0) {
        return res.status(404).json({ error: "Kh√¥ng t√¨m th·∫•y t√†i li·ªáu" });
      }

      res.status(204).send();
    } catch (error) {
      console.error("Error deleting file:", error);
      res.status(500).json({ error: "L·ªói khi x√≥a t√†i li·ªáu" });
    }
  });

  app.get("/api/file-hop-dong/:id/download", async (req, res) => {
    try {
      const id = parseInt(req.params.id);
      const items = await db
        .select()
        .from(schema.fileHopDong)
        .where(eq(schema.fileHopDong.id, id));

      if (items.length === 0) {
        return res.status(404).json({ error: "Kh√¥ng t√¨m th·∫•y t√†i li·ªáu" });
      }

      const document = items[0];

      if (!document.noiDungFile) {
        return res.status(404).json({ error: "File kh√¥ng t·ªìn t·∫°i" });
      }

      // Extract base64 content from data URL
      const base64Content = document.noiDungFile.split(",")[1];
      const buffer = Buffer.from(base64Content, "base64");

      // Set appropriate headers
      res.setHeader(
        "Content-Type",
        document.loaiFile || "application/octet-stream"
      );
      res.setHeader(
        "Content-Disposition",
        `attachment; filename="${document.tenFile}"`
      );
      res.setHeader("Content-Length", buffer.length);

      res.send(buffer);
    } catch (error) {
      console.error("Error downloading file:", error);
      res.status(500).json({ error: "L·ªói khi t·∫£i file" });
    }
  });

  // Lo·∫°i trang b·ªã
  app.get("/api/loai-trang-bi", async (req, res) => {
    try {
      const items = await db.select().from(schema.loaiTrangBi);
      res.json(items);
    } catch (error) {
      console.error("Error fetching loai trang bi:", error);
      res.status(500).json({ error: "L·ªói server" });
    }
  });

  // Lo·∫°i thanh to√°n
  app.get("/api/loai-thanh-toan", async (req, res) => {
    try {
      const items = await db.select().from(schema.loaiThanhToan);
      res.json(items);
    } catch (error) {
      console.error("Error fetching loai thanh toan:", error);
      res.status(500).json({ error: "L·ªói server" });
    }
  });

  // Lo·∫°i h√¨nh th·ª©c thanh to√°n
  app.get("/api/loai-hinh-thuc-thanh-toan", async (req, res) => {
    try {
      const items = await db.select().from(schema.loaiHinhThucThanhToan);
      res.json(items);
    } catch (error) {
      console.error("Error fetching loai hinh thuc thanh toan:", error);
      res.status(500).json({ error: "L·ªói server" });
    }
  });

  // ƒê·ªãa ƒëi·ªÉm th√¥ng quan routes
  app.get("/api/dia-diem-thong-quan", async (req, res) => {
    try {
      const items = await db.select().from(schema.diaDiemThongQuan);
      res.json(items);
    } catch (error) {
      console.error("Error fetching dia diem thong quan:", error);
      res.status(500).json({ error: "L·ªói server" });
    }
  });

  app.post("/api/dia-diem-thong-quan", async (req, res) => {
    console.log("Received request body:", req.body);
    try {
      const validatedData = insertDiaDiemThongQuanSchema.parse(req.body);
      console.log("Validated Data:", validatedData);
      const items = await db
        .insert(schema.diaDiemThongQuan)
        .values(validatedData)
        .returning();
      res.status(201).json(items[0]);
    } catch (error) {
      console.error("Error creating dia diem thong quan:", error);
      res.status(500).json({ error: "L·ªói khi t·∫°o ƒë·ªãa ƒëi·ªÉm th√¥ng quan" });
    }
  });
  app.put("/api/dia-diem-thong-quan/:id", async (req, res) => {
    const id = req.params.id;

    try {
      // Validate d·ªØ li·ªáu g·ª≠i l√™n
      const validatedData = insertDiaDiemThongQuanSchema.parse(req.body);

      const updated = await db
        .update(schema.diaDiemThongQuan)
        .set(validatedData)
        .where(eq(schema.diaDiemThongQuan.id, Number(id)))
        .returning();

      if (updated.length === 0) {
        return res
          .status(404)
          .json({ error: "Kh√¥ng t√¨m th·∫•y ƒë·ªãa ƒëi·ªÉm ƒë·ªÉ c·∫≠p nh·∫≠t" });
      }

      res.json({ message: "C·∫≠p nh·∫≠t th√†nh c√¥ng", item: updated[0] });
    } catch (error) {
      console.error("Error updating dia diem thong quan:", error);
      res.status(500).json({ error: "L·ªói khi c·∫≠p nh·∫≠t ƒë·ªãa ƒëi·ªÉm th√¥ng quan" });
    }
  });
  app.delete("/api/dia-diem-thong-quan/:id", async (req, res) => {
    const id = req.params.id;

    try {
      const deleted = await db
        .delete(schema.diaDiemThongQuan)
        .where(eq(schema.diaDiemThongQuan.id, Number(id)))
        .returning();

      if (deleted.length === 0) {
        return res
          .status(404)
          .json({ error: "Kh√¥ng t√¨m th·∫•y ƒë·ªãa ƒëi·ªÉm ƒë·ªÉ x√≥a" });
      }

      res.json({ message: "X√≥a th√†nh c√¥ng", item: deleted[0] });
    } catch (error) {
      console.error("Error deleting dia diem thong quan:", error);
      res.status(500).json({ error: "L·ªói khi x√≥a ƒë·ªãa ƒëi·ªÉm th√¥ng quan" });
    }
  });

  // Ti·∫øp nh·∫≠n routes
  app.get("/api/tiep-nhan", async (req, res) => {
    try {
      const items = await db.select().from(schema.tiepNhan);
      res.json(items);
    } catch (error) {
      console.error("Error fetching tiep nhan:", error);
      res.status(500).json({ error: "L·ªói server" });
    }
  });

  app.get("/api/tiep-nhan/:id", async (req, res) => {
    try {
      const id = parseInt(req.params.id);
      const items = await db
        .select()
        .from(schema.tiepNhan)
        .where(eq(schema.tiepNhan.id, id));
      if (items.length === 0) {
        return res.status(404).json({ error: "Kh√¥ng t√¨m th·∫•y ti·∫øp nh·∫≠n" });
      }
      res.json(items[0]);
    } catch (error) {
      console.error("Error fetching tiep nhan by id:", error);
      res.status(500).json({ error: "L·ªói khi l·∫•y ti·∫øp nh·∫≠n" });
    }
  });

  app.get("/api/tiep-nhan/hop-dong/:hopDongId", async (req, res) => {
    try {
      const hopDongId = parseInt(req.params.hopDongId);
      const items = await db
        .select()
        .from(schema.tiepNhan)
        .where(eq(schema.tiepNhan.hopDongId, hopDongId));
      res.json(items);
    } catch (error) {
      console.error("Error fetching tiep nhan by hop dong:", error);
      res.status(500).json({ error: "L·ªói server" });
    }
  });

  app.post("/api/tiep-nhan", async (req, res) => {
    try {
      const validatedData = insertTiepNhanSchema.parse(req.body);
      const items = await db
        .insert(schema.tiepNhan)
        .values(validatedData)
        .returning();
      res.status(201).json(items[0]);
    } catch (error) {
      console.error("Error creating tiep nhan:", error);
      res.status(500).json({ error: "L·ªói khi t·∫°o ti·∫øp nh·∫≠n" });
    }
  });

  app.put("/api/tiep-nhan/:id", async (req, res) => {
    try {
      const id = parseInt(req.params.id);
      const validatedData = insertTiepNhanSchema.partial().parse(req.body);
      const items = await db
        .update(schema.tiepNhan)
        .set(validatedData)
        .where(eq(schema.tiepNhan.id, id))
        .returning();
      if (items.length === 0) {
        return res.status(404).json({ error: "Kh√¥ng t√¨m th·∫•y ti·∫øp nh·∫≠n" });
      }
      res.json(items[0]);
    } catch (error) {
      console.error("Error updating tiep nhan:", error);
      res.status(500).json({ error: "L·ªói khi c·∫≠p nh·∫≠t ti·∫øp nh·∫≠n" });
    }
  });

  app.delete("/api/tiep-nhan/:id", async (req, res) => {
    try {
      const id = parseInt(req.params.id);
      const items = await db
        .delete(schema.tiepNhan)
        .where(eq(schema.tiepNhan.id, id))
        .returning();
      if (items.length === 0) {
        return res.status(404).json({ error: "Kh√¥ng t√¨m th·∫•y ti·∫øp nh·∫≠n" });
      }
      res.status(204).send();
    } catch (error) {
      console.error("Error deleting tiep nhan:", error);
      res.status(500).json({ error: "L·ªói khi x√≥a ti·∫øp nh·∫≠n" });
    }
  });
  // ƒêi·ªÅu ki·ªán giao h√†ng
  app.get("/api/dieu-kien-giao-hang", async (req, res) => {
    try {
      const items = await db.select().from(schema.dieuKienGiaoHang);
      res.json(items);
    } catch (error) {
      console.error("Error fetching incoterm:", error);
      res.status(500).json({ error: "L·ªói server" });
    }
  });
  // File: server/index.ts ho·∫∑c server/api/export.ts (tu·ª≥ v√†o c·∫•u tr√∫c d·ª± √°n b·∫°n)

  app.get("/api/export/hop-dong", async (req, res) => {
    try {
      const rows = await db
        .select({
          hopDong: {
            id: schema.hopDong.id,
            ten: schema.hopDong.ten,
            soHdNoi: schema.hopDong.soHdNoi,
            soHdNgoai: schema.hopDong.soHdNgoai,
            ngay: schema.hopDong.ngay,
            giaTriHopDong: schema.hopDong.giaTriHopDong,
            moTa: schema.hopDong.moTa,
            phiUyThac: schema.hopDong.phiUyThac,
            tyGia: schema.hopDong.tyGia,
          },
          canBo: {
            ten: schema.canBo.ten,
            email: schema.canBo.email,
          },
          nhaCungCap: {
            ten: schema.nhaCungCap.ten,
            diaChi: schema.nhaCungCap.diaChi,
            soDienThoai: schema.nhaCungCap.soDienThoai,
          },
          chuDauTu: {
            ten: schema.chuDauTu.ten,
          },
          capTien: {
            id: schema.capTien.id,
            ngayCap: schema.capTien.ngayCap,
            soTien: schema.capTien.soTien,
            loaiTienId: schema.capTien.loaiTienId,
            tyGia: schema.capTien.tyGia,
            ghiChu: schema.capTien.ghiChu,
            hopDongId: schema.capTien.hopDongId,
          },
        })
        .from(schema.hopDong)
        .leftJoin(schema.canBo, eq(schema.hopDong.canBoId, schema.canBo.id))
        .leftJoin(
          schema.nhaCungCap,
          eq(schema.hopDong.nhaCungCapId, schema.nhaCungCap.id)
        )
        .leftJoin(
          schema.chuDauTu,
          eq(schema.hopDong.chuDauTuId, schema.chuDauTu.id)
        )
        .leftJoin(
          schema.capTien,
          eq(schema.capTien.hopDongId, schema.hopDong.id)
        );

      // Gom c√°c b·∫£n ghi capTien v√†o t·ª´ng h·ª£p ƒë·ªìng
      const result = Object.values(
        rows.reduce((acc: any, row: any) => {
          const hdId = row.hopDong.id;
          if (!acc[hdId]) {
            acc[hdId] = {
              hopDong: row.hopDong,
              canBo: row.canBo,
              nhaCungCap: row.nhaCungCap,
              chuDauTu: row.chuDauTu,
              capTien: [],
            };
          }
          if (row.capTien?.id) {
            acc[hdId].capTien.push({
              id: row.capTien.id,
              ngayCap: row.capTien.ngayCap,
              soTien: row.capTien.soTien,
              loaiTienId: row.capTien.loaiTienId,
              tyGia: row.capTien.tyGia,
              ghiChu: row.capTien.ghiChu,
            });
          }
          return acc;
        }, {})
      );

      res.json(result);
    } catch (error) {
      console.error("Export hop dong error:", error);
      res.status(500).json({ error: "L·ªói server khi export h·ª£p ƒë·ªìng" });
    }
  });
}
